---
title: 個人的使えるPromQL on GCP
date: '2026-01-08'
tags:
  - GCP
  - Prometheus
published: true
---


### CPU使用率をコンテナごとに集計して表示

```sql
max by (container_name) (
    max_over_time(
        {"__name__"="kubernetes.io/container/cpu/limit_utilization",
        "monitored_resource"="k8s_container",
        "location"="asia-northeast1",
        "container_name"=~"a-service-app|b-service-app"}[15m]
    )
)
```

解説
- `max by (container_name)`：コンテナ名で集計する。`max`は変更可能で、各コンテナのCPU使用率の平均値がほしければ`avg`を使用する。`by (...)`は集計するキー。
- `max_over_time`：時間範囲内の最大値を取る。
- `=~`でサービス名名を部分一致で指定する。さらに`|`で複数のサービス名を指定する。
- [15m]：時間範囲を15分に設定する。`__interval__`で自動。